<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <title>Получение HTML-кода модуля</title>
        <!--Import Google Icon Font-->
        <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <!--Import materialize.css-->
        <link type="text/css" rel="stylesheet" href="./libs/Materialize/dist/css/materialize.min.css"  media="screen,projection"/>

        <!--Let browser know website is optimized for mobile-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>
    <body>
        <div class="container">
            <h3>Получение HTML-кода модуля</h3>

            <main>
                <div class="row">

                    <form id="сodeGeneratorForm" method="get" action="" class="col s12">
                            <div class="row">
                                <div class="input-field col s6">
                                    <input id="siteUrl" name="siteUrl" type="text" class="validate" placeholder="http://yandex.ru" required>
                                    <label for="siteUrl">Сайт на котором будет использоваться модуль</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s6">
                                    <select id="formType" name="formType">
                                        <option value="" disabled selected>Выберите опцию</option>
                                        <option value="calculation">Просчет</option>
                                        <option value="measurement" disabled>Замер</option>
                                        <option value="credit" disabled>Кредит</option>
                                    </select>
                                    <label for="formType">Тип заявки</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s6">
                                    <select id="style" name="style">
                                        <option value="" disabled selected>Выберите опцию</option>
                                        <option value="false">Из настроек сайта</option>
                                        <option value="/css/um-material.css">Material Design</option>
                                    </select>
                                    <label for="style">Стиль окна</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s6">
                                    <select id="initType" name="initType">
                                        <option value="" disabled selected>Выберите опцию</option>
                                        <option value="button">Кнопка</option>
                                        <option value="form">Форма</option>
                                    </select>
                                    <label for="initType">Тип генерируемого кода</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s6">
                                    <select id="initPosition" name="initPosition">
                                        <option value="" disabled selected>Выберите опцию</option>
                                        <option value="fixed">Фиксированный относительно окна браузера</option>
                                        <option value="static">В статичном элементе</option>
                                    </select>
                                    <label for="initPosition">Начальное отображение</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col s6">
                                    <p>Возможность выбора студий</p>
                                    <div class="switch">
                                        <label>
                                            Off
                                            <input type="checkbox" name="showShop">
                                            <span class="lever"></span>
                                            On
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col s6">
                                    <p>Показывать студии на карте</p>
                                    <div class="switch">
                                        <label>
                                            Off
                                            <input type="checkbox" name="showMap">
                                            <span class="lever"></span>
                                            On
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s12">
                                    <textarea id="code" name="code" class="materialize-textarea" placeholder="HTML-код"></textarea>
                                    <label for="code">HTML-код</label>
                                </div>
                                <p><i class="material-icons">&#xE002;</i> Внимание! При внесении каких-либо изменений в этот
                                    код работоспособность не гарантируется!</p>
                            </div>
                        </form>

                    <div id="example" class="col s12"></div>

                </div>
            </main>
        </div>

        <script src="./libs/jquery/dist/jquery.min.js"></script>
        <script src="./libs/underscore/underscore-min.js"></script>
        <script src="./libs/backbone/backbone-min.js"></script>
        <script src="./libs/Materialize/dist/js/materialize.min.js"></script>
        <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&mode=debug"></script>
        <script src="./js/marya-um.js"></script>

        <script>
            $(document).ready(function() {
                $('select').material_select();
                window.validate_field = function(){}; //отмена встроенного валидатора Materialize

                window.App = {
                    Models: {},
                    Collections: {},
                    Views: {},
                    Router: {}
                };

                function init() {
                    App.config = new App.Models.Config;
                    App.formCode = new App.Views.CodeGeneratorForm({model: App.config});
                    App.example = new App.Views.Example({model: App.config});
                }

                App.Models.Config = Backbone.Model.extend({
                    defaults: {
                        serverUrl: 'http://umodule.marya.ru',
                        siteUrl: '',
                        formType: 'calculation',
                        style: '/css/um-material.css',
                        initType: 'button',
                        initPosition: 'fixed',
                        showMap: false,
                        showShop: false
                    },

                    urlRoot: function () {
                        return this.get('serverUrl') + '/api/configs/'
                    },

                    initialize: function () {
                        /** @todo временное решение для получения имя сервера отдающего кнопку*/
                        var hostname = window.location.origin;
                        this.set('serverUrl', hostname);
                        this.on('sync', this.log, this);
                    },

                    validate: function (attrs, options) {
                        /** @todo проверить корректность регулярки*/
                        var regURL = /^(https?:\/\/)?([\S\.]+)\.(\S{2,6}\.?)(\/[\S\.]*)*\/?$/;

                        var errors = [];
                        if (!attrs.siteUrl) {
                            errors.push({
                                text: 'Вы не заполнили поле "Сайт на котором будет использоваться модуль',
                                attr: 'siteUrl'
                            });
                        } else if (!regURL.test(attrs.siteUrl)) {
                            errors.push({
                                text: "Сайт не коректен",
                                attr: 'siteUrl'
                            });
                        }

                        if (errors.length) return errors;
                    },

                    log: function () {
                        console.log(this.toJSON());
                    },

                    getButtonDOM: function() {
                        return '<button id="um-btn-init" class="um-btn um-btn--raised um-btn-red">Заказать кухню</button>'
                    },

                    getFormDOM: function() {
                        return '<div id="um-form-init"></div>'
                    },

                    getScript: function () {
                        return '<script type="text/javascript" src="' + this.get('serverUrl') + '/js/marya-um.js"><\/script>' +
                               '<script>UM.init(' + JSON.stringify(this.toJSON()) + ');<\/script>';
                    },

                    getCode: function () {
                        if (this.get('initPosition') == 'fixed') {

                            return  this.getScript();

                        } else if (this.get('initPosition') == 'static') {

                            if (this.get('initType') == 'button')
                                return this.getButtonDOM() + this.getScript();
                            else if(this.get('initType') == 'form')
                                return this.getFormDOM() + this.getScript();

                        } else {

                            throw new Error("Не указано initPosition '" + this.get('initPosition') + "' проверьте конфигурацию");

                        }
                    }
                });

                App.Views.CodeGeneratorForm = Backbone.View.extend({
                    el: '#сodeGeneratorForm',

                    events: {
                        "input input:text"  : "changed",
                        "change input"      : "changed",
                        "change select"     : "changed"
                    },

                    initialize: function () {
                        this.listenTo(this.model, 'sync', this.renderCode);
                        this.listenTo(this.model, 'invalid', this.invalid);
                        this.listenTo(this.model, 'request', this.valid);
                        _.bindAll(this, 'changed');
                    },

                    renderCode: function () {
                        this.$el.find('[name=code]').val(this.model.getCode());
                    },

                    changed: function(e) {
                        var changed = e.currentTarget;

                        var value;
                        if (changed.type == 'checkbox') {
                            value = changed.checked;
                        } else {
                            value = changed.value;
                        }

                        var obj = {};
                        obj[changed.name] = value;
                        this.model.save(obj);
                    },

                    valid: function () {
                        this.$el.find('input')
                                .removeClass('invalid')
                                .addClass('valid');
                    },

                    invalid: function (model, errors) {
                        this.$el.find('input')
                                .removeClass('invalid')
                                .removeClass('valid');
                        _.each(errors, function (error) {
                            var $el = this.$el.find('[name=' + error.attr + ']');

                            $el.removeClass('valid')
                                .addClass('invalid');
                        }, this);
                    }
                });

                App.Views.Example = Backbone.View.extend({
                    el: '#example',

                    initialize: function () {
                        this.render();
                        this.listenTo(this.model, 'sync', this.render);
                    },

                    render: function () {
                        if(UM.page)
                            UM.page.unrender();

                        if(UM.button && UM.button.$el.hasClass('um-btn-start--fixed'))
                            UM.button.unrender();

                        if (this.model.get('initPosition') == 'static') {

                            if (this.model.get('initType') == 'button')
                                this.$el.html(this.model.getButtonDOM());

                            else if (this.model.get('initType') == 'form')
                                this.$el.html(this.model.getFormDOM());

                        } else this.$el.html('');



                        UM.init(this.model.toJSON());
                    }

                });

                init();
            });
        </script>
    </body>
</html>